name: Deploy to Tencent COS

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡è¿è¡Œ
concurrency:
  group: tencent-cos-deployment
  cancel-in-progress: true

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
      - deploy
  repository_dispatch:
    types: [submodule-update]
  workflow_dispatch:

env:
  # ä½¿ç”¨é¡¹ç›®è¦æ±‚çš„ Node.js ç‰ˆæœ¬
  NODE_VERSION: '20'
  PNPM_VERSION: '10.7.0'
  # æ·»åŠ ç¯å¢ƒå˜é‡æ§åˆ¶å¯é€‰åŠŸèƒ½
  ENABLE_SUBMODULE_UPDATE: ${{ vars.ENABLE_SUBMODULE_UPDATE || 'false' }}
  ENABLE_TYPE_CHECK: ${{ vars.ENABLE_TYPE_CHECK || 'true' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          submodules: true
          fetch-depth: 0

      # 2. æ›´æ–°å­æ¨¡å—ï¼ˆå¦‚æœéœ€è¦ï¼‰
      - name: Update submodules
        if: env.ENABLE_SUBMODULE_UPDATE == 'true'
        run: |
          git submodule update --remote
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git commit -am "docs: update content"
            git push
          fi

      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          check-latest: true

      # 4. è®¾ç½® pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # 5. è·å– pnpm store ç›®å½•
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # 6. ç¼“å­˜ pnpm store
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 7. ç¼“å­˜ Astro æ„å»ºäº§ç‰©
      - name: Cache Astro build
        uses: actions/cache@v4
        with:
          path: |
            .astro
            node_modules/.astro
          key: ${{ runner.os }}-astro-${{ hashFiles('**/astro.config.*') }}-${{ hashFiles('src/**/*') }}
          restore-keys: |
            ${{ runner.os }}-astro-${{ hashFiles('**/astro.config.*') }}-
            ${{ runner.os }}-astro-

      # 8. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      # 9. è¿è¡Œç±»å‹æ£€æŸ¥å’Œä»£ç è´¨é‡æ£€æŸ¥
      - name: Type check and lint
        if: env.ENABLE_TYPE_CHECK == 'true'
        run: |
          pnpm astro check
          pnpm lint

      # 10. æ„å»ºé¡¹ç›®
      - name: Build project
        run: pnpm build

      # 11. éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build output directory 'dist' not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html not found in build output"
            exit 1
          fi
          echo "âœ… Build verification passed"
          echo "ğŸ“Š Build output size: $(du -sh dist)"

      # 12. éƒ¨ç½²åˆ°è…¾è®¯äº‘ COS å¹¶åˆ·æ–° CDN
      - name: Deploy to Tencent COS and refresh CDN
        uses: ceynri/tencent-cos-and-cdn-action@master
        with:
          # è…¾è®¯äº‘ API å¯†é’¥ ID
          secret_id: ${{ secrets.TENCENT_SECRET_ID }}
          # è…¾è®¯äº‘ API å¯†é’¥ Key
          secret_key: ${{ secrets.TENCENT_SECRET_KEY }}
          # COS å­˜å‚¨æ¡¶åç§° (eg: my-website-1234567890)
          cos_bucket: ${{ secrets.TENCENT_COS_BUCKET }}
          # COS å­˜å‚¨æ¡¶åŒºåŸŸ (eg: ap-shanghai)
          cos_region: ${{ secrets.TENCENT_COS_REGION }}
          # æŒ‡å®š COS å­˜å‚¨ç±»å‹ä¸ºå¤š AZ æ ‡å‡†ç±»å‹
          cos_put_options: '{"StorageClass":"MAZ_STANDARD"}'
          # æ˜¯å¦æ›¿æ¢åŒåæ–‡ä»¶
          cos_replace_file: false
          # ä½¿ç”¨ COS çš„åŠ é€ŸåŸŸåè¿›è¡Œä¸Šä¼ 
          cos_accelerate: true
          # CDN åŸŸåå‰ç¼€ (eg: https://cdn.example.com/)
          cdn_prefix: ${{ secrets.TENCENT_CDN_PREFIX }}
          # ç­‰å¾… CDN åˆ·æ–°å®Œæˆå†ç»“æŸ step
          cdn_wait_flush: true
          # é¡¹ç›®æ–‡ä»¶æœ¬åœ°è·¯å¾„
          local_path: dist
          # COS æ¡¶ä¸Šä¼ è·¯å¾„
          remote_path: /
          # ä¸Šä¼ å®Œåæ¸…ç† remote_path ä¸­éæœ¬æ¬¡ä¸Šä¼ çš„æ–‡ä»¶
          clean: true

      # 13. éƒ¨ç½²ç»“æœ
      - name: Deployment result summary
        run: |
          echo "âœ… Deployment successful! Website has been updated to Tencent COS, CDN cache has been refreshed."
          echo "ğŸ‰ Build output size: $(du -sh dist | cut -f1)"
          echo "ğŸ“… Deployment time: $(date)"

  # éƒ¨ç½²åçš„å¥åº·æ£€æŸ¥
  health-check:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Health check
        run: |
          if [ -n "${{ secrets.TENCENT_CDN_PREFIX }}" ]; then
            echo "ğŸ” Checking deployment status..."
            
            # ç­‰å¾… CDN åˆ·æ–°å®Œæˆ
            sleep 30
            
            # æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯è®¿é—®
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${{ secrets.TENCENT_CDN_PREFIX }}" || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… Website health check passed (HTTP $HTTP_STATUS)"
            else
              echo "âš ï¸ Website health check failed (HTTP $HTTP_STATUS)"
              echo "This might be due to CDN cache not being refreshed yet, please try again later"
              exit 1
            fi
          else
            echo "â„¹ï¸ Skipping health check: CDN domain not configured"
          fi
