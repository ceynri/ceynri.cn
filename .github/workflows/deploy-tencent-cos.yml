name: Deploy to Tencent COS

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªéƒ¨ç½²ä»»åŠ¡è¿è¡Œ
concurrency:
  group: tencent-cos-deployment
  cancel-in-progress: true

# è§¦å‘æ¡ä»¶
on:
  push:
    branches:
      - main
      - deploy
  repository_dispatch:
    types: [submodule-update]
  workflow_dispatch:

env:
  # ä½¿ç”¨é¡¹ç›®è¦æ±‚çš„ Node.js ç‰ˆæœ¬
  NODE_VERSION: '20'
  PNPM_VERSION: '10.7.0'
  # æ·»åŠ ç¯å¢ƒå˜é‡æ§åˆ¶å¯é€‰åŠŸèƒ½
  ENABLE_SUBMODULE_UPDATE: ${{ vars.ENABLE_SUBMODULE_UPDATE || 'false' }}
  ENABLE_TYPE_CHECK: ${{ vars.ENABLE_TYPE_CHECK || 'true' }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: production

    outputs:
      deployment-url: ${{ steps.deploy.outputs.deployment-url }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          submodules: true
          fetch-depth: 0

      # 2. æ›´æ–°å­æ¨¡å—ï¼ˆå¦‚æœéœ€è¦ï¼‰
      - name: Update submodules
        if: env.ENABLE_SUBMODULE_UPDATE == 'true'
        run: |
          git submodule update --remote
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain)" ]; then
            git commit -am "docs: update content"
            git push
          fi

      # 3. è®¾ç½® Node.js ç¯å¢ƒ
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          check-latest: true

      # 4. è®¾ç½® pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      # 5. è·å– pnpm store ç›®å½•
      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      # 6. ç¼“å­˜ pnpm store
      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 7. ç¼“å­˜ Astro æ„å»ºäº§ç‰©
      - name: Cache Astro build
        uses: actions/cache@v4
        with:
          path: |
            .astro
            node_modules/.astro
          key: ${{ runner.os }}-astro-${{ hashFiles('**/astro.config.*') }}-${{ hashFiles('src/**/*') }}
          restore-keys: |
            ${{ runner.os }}-astro-${{ hashFiles('**/astro.config.*') }}-
            ${{ runner.os }}-astro-

      # 8. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: pnpm install --frozen-lockfile --prefer-offline

      # 9. è¿è¡Œç±»å‹æ£€æŸ¥å’Œä»£ç è´¨é‡æ£€æŸ¥
      - name: Type check and lint
        if: env.ENABLE_TYPE_CHECK == 'true'
        run: |
          pnpm astro check
          pnpm lint

      # 10. æ„å»ºé¡¹ç›®
      - name: Build project
        run: pnpm build

      # 11. éªŒè¯æ„å»ºäº§ç‰©
      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ Build output directory 'dist' not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ index.html not found in build output"
            exit 1
          fi
          echo "âœ… Build verification passed"
          echo "ğŸ“Š Build output size: $(du -sh dist)"

      # 12. éƒ¨ç½²åˆ°è…¾è®¯äº‘ COS å¹¶åˆ·æ–° CDN
      - name: Deploy to Tencent COS and refresh CDN
        id: deploy
        uses: ceynri/tencent-cos-and-cdn-action@v1.0.3-3
        with:
          secret_id: ${{ secrets.TENCENT_SECRET_ID }}
          secret_key: ${{ secrets.TENCENT_SECRET_KEY }}
          cos_bucket: ${{ secrets.TENCENT_COS_BUCKET }}
          cos_region: ${{ secrets.TENCENT_COS_REGION }}
          storage_class: MAZ_STANDARD
          cos_accelerate: true
          cdn_prefix: ${{ secrets.TENCENT_CDN_PREFIX }}
          local_path: dist
          remote_path: /
          clean: true

      # 13. è¾“å‡ºéƒ¨ç½²ä¿¡æ¯
      - name: Output deployment info
        run: |
          echo "ğŸš€ éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“… éƒ¨ç½²æ—¶é—´: $(date)"
          echo "ğŸ”— COS å­˜å‚¨æ¡¶: ${{ secrets.TENCENT_COS_BUCKET }}"
          echo "ğŸŒ COS åŒºåŸŸ: ${{ secrets.TENCENT_COS_REGION }}"
          if [ -n "${{ secrets.TENCENT_CDN_PREFIX }}" ]; then
            echo "ğŸš€ CDN åœ°å€: ${{ secrets.TENCENT_CDN_PREFIX }}"
            echo "deployment-url=${{ secrets.TENCENT_CDN_PREFIX }}" >> $GITHUB_OUTPUT
          fi

      # 14. éƒ¨ç½²çŠ¶æ€é€šçŸ¥
      - name: Deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼ç½‘ç«™å·²æ›´æ–°åˆ°è…¾è®¯äº‘ COSï¼ŒCDN ç¼“å­˜å·²åˆ·æ–°ã€‚"
            echo "ğŸ‰ æ„å»ºäº§ç‰©å¤§å°: $(du -sh dist | cut -f1)"
            echo "â° æ€»æ‰§è¡Œæ—¶é—´: ${{ steps.deploy.conclusion }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ„å»ºæ—¥å¿—ã€‚"
            echo "ğŸ” å¯èƒ½çš„åŸå› ï¼š"
            echo "  - è…¾è®¯äº‘ API å¯†é’¥é…ç½®é”™è¯¯"
            echo "  - COS å­˜å‚¨æ¡¶æƒé™ä¸è¶³"
            echo "  - ç½‘ç»œè¿æ¥é—®é¢˜"
            echo "  - æ„å»ºè¿‡ç¨‹å‡ºç°é”™è¯¯"
          fi

  # å¯é€‰ï¼šéƒ¨ç½²åçš„å¥åº·æ£€æŸ¥
  health-check:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: success() && needs.build-and-deploy.outputs.deployment-url != ''

    steps:
      - name: Health check
        run: |
          DEPLOYMENT_URL="${{ needs.build-and-deploy.outputs.deployment-url }}"
          if [ -n "$DEPLOYMENT_URL" ]; then
            echo "ğŸ” æ­£åœ¨æ£€æŸ¥éƒ¨ç½²çŠ¶æ€..."
            
            # ç­‰å¾… CDN åˆ·æ–°å®Œæˆ
            sleep 30
            
            # æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯è®¿é—®
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL" || echo "000")
            
            if [ "$HTTP_STATUS" = "200" ]; then
              echo "âœ… ç½‘ç«™å¥åº·æ£€æŸ¥é€šè¿‡ (HTTP $HTTP_STATUS)"
            else
              echo "âš ï¸ ç½‘ç«™å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $HTTP_STATUS)"
              echo "è¿™å¯èƒ½æ˜¯ CDN ç¼“å­˜è¿˜æœªåˆ·æ–°å®Œæˆï¼Œè¯·ç¨åå†è¯•"
              exit 1
            fi
          else
            echo "â„¹ï¸ è·³è¿‡å¥åº·æ£€æŸ¥ï¼šæœªé…ç½® CDN åŸŸå"
          fi
