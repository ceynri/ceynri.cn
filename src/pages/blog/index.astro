---
import type { Page } from 'astro';
import type { CollectionEntry } from 'astro:content';

import { getCollection } from 'astro:content';

import { BaseHead, Pagination, PostCard } from '~/components';
import { BLOG_POST_PER_PAGE, SITE_DESCRIPTION, SITE_TITLE } from '~/consts';
import { AsideLayout } from '~/layouts';

// 获取所有博客文章
const rawPosts = (await getCollection('blog', ({ data }) => import.meta.env.DEV || data.published));
const posts = rawPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// 手动创建第一页数据
const pageSize = BLOG_POST_PER_PAGE;
const firstPagePosts = posts.slice(0, pageSize);
const totalPages = Math.ceil(posts.length / pageSize);

// 创建分页数据结构
const page: Page<CollectionEntry<'blog'>> = {
  data: firstPagePosts,
  start: 0,
  end: Math.min(pageSize - 1, posts.length - 1),
  size: pageSize,
  total: posts.length,
  currentPage: 1,
  lastPage: totalPages,
  url: {
    current: '/blog/',
    next: totalPages > 1 ? '/blog/2' : undefined,
    prev: undefined,
    first: '/blog/',
    last: totalPages > 1 ? `/blog/${totalPages}` : '/blog/',
  },
};
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <BaseHead
      title={SITE_TITLE}
      description={SITE_DESCRIPTION}
    />
  </head>
  <body>
    <AsideLayout>
      {page.data.map((post) => (
        <PostCard post={post} />
      ))}

      {totalPages > 1 && <Pagination page={page} />}
    </AsideLayout>
  </body>
</html>
