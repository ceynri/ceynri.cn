---
import { getCollection } from 'astro:content';

import { BaseHead, PostCard } from '~/components';
import { SITE_TITLE } from '~/consts';
import { AsideLayout } from '~/layouts';

export async function getStaticPaths() {
  const posts = await getCollection('blog', ({ data }) => import.meta.env.DEV || data.published);

  // 先按标签分组文章
  const postsByTag = posts.reduce((acc, post) => {
    post.data.tags?.forEach((tag) => {
      if (!acc[tag]) {
        acc[tag] = [];
      }
      acc[tag].push(post);
    });
    return acc;
  }, {} as Record<string, typeof posts>);

  // 为每个标签创建页面
  return Object.entries(postsByTag).map(([tag, tagPosts]) => ({
    params: { tag },
    props: {
      tag,
      posts: tagPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime()),
    },
  }));
}

const { tag, posts } = Astro.props;
---

<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <BaseHead title={`#${tag} - ${SITE_TITLE}`} description={`标签为 ${tag} 的所有文章`} />
  </head>
  <body>
    <AsideLayout>
      <div class="p-prose bg-[var(--prose-bg-color)] transition-[background-color] ease-out rounded-2xl mb-8">
        <h1 class="text-4xl font-[600] mb-4 text-[var(--title-color)]"><span class="sparkle-text">#</span> {tag.toUpperCase()}</h1>
        <p class="text-[var(--text-secondary-color)]">{posts.length} {posts.length > 1 ? 'POSTS' : 'POST'}</p>
      </div>

      {posts.map((post) => (
        <PostCard post={post} />
      ))}
    </AsideLayout>
  </body>
</html>
